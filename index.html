<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hack.Chat — Cleaner UI</title>
<style>
  :root{
    --bg:#0f1720; --panel:#0b1220; --muted:#9aa6b2; --accent:#6ee7b7;
    --msg-bg: rgba(255,255,255,0.02);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021,#0b1220);color:#e6eef6}
  .app{display:flex;max-width:1100px;margin:18px auto;height:calc(100vh - 36px);border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
  .left{flex:1;display:flex;flex-direction:column;background:var(--panel);padding:14px 16px;gap:10px}
  .header{display:flex;align-items:center;justify-content:space-between}
  .room{font-weight:600;letter-spacing:0.2px}
  .status{font-size:12px;color:var(--muted)}
  .messages{flex:1;overflow:auto;padding:6px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
  .msg{padding:8px 10px;margin:6px 0;border-radius:8px;background:var(--msg-bg);display:flex;gap:10px;align-items:flex-start}
  .avatar{width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:#071021}
  .meta{font-size:13px}
  .nick{font-weight:700}
  .time{font-size:11px;color:var(--muted);margin-left:8px}
  .text{margin-top:4px;color:#dff1e9;white-space:pre-wrap}
  .composer{display:flex;gap:8px;align-items:center}
  .input{flex:1;background:#02101a;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;color:inherit}
  .send{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;font-weight:700;color:#052322;cursor:pointer}
  .right{width:260px;background:linear-gradient(180deg,#061021,#071019);padding:12px;display:flex;flex-direction:column;gap:10px}
  .users{overflow:auto;flex:1;padding:6px}
  .user{display:flex;gap:8px;align-items:center;padding:6px;border-radius:8px}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:12px;color:var(--muted)}
  .notice{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;font-size:13px}
  @media(max-width:900px){
    .app{flex-direction:column;height:auto;margin:12px}
    .right{width:100%;order:3}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="left">
    <div class="header">
      <div>
        <div class="room" id="roomName">room</div>
        <div class="status" id="status">connecting…</div>
      </div>
      <div class="small" id="nickLabel">nick</div>
    </div>

    <div class="messages" id="messages" aria-live="polite"></div>

    <div class="composer">
      <input id="messageInput" class="input" placeholder="Type a message and press Enter…" autocomplete="off" />
      <button id="sendBtn" class="send">Send</button>
    </div>
  </div>

  <aside class="right">
    <div class="notice">
      <div style="font-weight:700">Users in room</div>
      <div class="small" id="hint">This is a wrapper client for hack.chat — same room, nicer UI.</div>
    </div>
    <div class="users" id="users"></div>

    <div class="notice small">Room URL format: <code>/?room=roomname&nick=yourname</code></div>
  </aside>
</div>

<script>
/*
  Simple hack.chat wrapper client.
  - Gateway: wss://hack.chat/chat-ws
  - Join payload format used by community clients:
      { cmd: "join", channel: ROOM, nick: NICK, pass: optionalPass }
  - To send messages we use { cmd: "say", channel: ROOM, text: TEXT }
  Notes: This client is intentionally minimal. You can extend: markdown, file share, colors etc.
*/

const WS_GATEWAY = 'wss://hack.chat/chat-ws';

// helpers
const $ = id => document.getElementById(id);
const qs = (k, fallback) => (new URLSearchParams(location.search).get(k) || fallback);

let room = (qs('room') || '').trim();
let nick = (qs('nick') || '').trim();
if (!room) room = prompt("Room name (shared with other people):", "programming") || "programming";
if (!nick) nick = prompt("Choose a nickname (what others see):", "anon") || ("anon"+Math.floor(Math.random()*999));

$('roomName').textContent = '# ' + room;
$('nickLabel').textContent = nick;

const messagesEl = $('messages');
const usersEl = $('users');
const statusEl = $('status');
const inputEl = $('messageInput');
const sendBtn = $('sendBtn');

let socket = null;
let online = new Set();

// deterministic color for a nick
function nickColor(n){
  let h = 0;
  for (let i=0;i<n.length;i++) h = (h<<5) - h + n.charCodeAt(i);
  h = Math.abs(h);
  const hue = h % 360;
  // pastel-ish background color (HSL)
  return `hsl(${hue} 70% 70%)`;
}

function addUser(n){
  online.add(n);
  renderUsers();
}
function removeUser(n){
  online.delete(n);
  renderUsers();
}
function setUserList(arr){
  online = new Set(arr || []);
  renderUsers();
}
function renderUsers(){
  usersEl.innerHTML = '';
  const sorted = Array.from(online).sort((a,b)=>a.localeCompare(b));
  for (const u of sorted){
    const d = document.createElement('div');
    d.className = 'user';
    d.innerHTML = `<div class="avatar" style="background:${nickColor(u)}">${(u[0]||'?').toUpperCase()}</div>
      <div style="flex:1"><div style="font-weight:700">${escapeHtml(u)}</div><div class="muted">online</div></div>`;
    usersEl.appendChild(d);
  }
}

function formatTime(ts){
  const d = new Date(ts || Date.now());
  return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

function escapeHtml(s){
  return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
}

function addMessage(nickStr, text, ts, opts = {}){
  const wrap = document.createElement('div');
  wrap.className = 'msg';
  const av = document.createElement('div');
  av.className='avatar';
  av.style.background = nickColor(nickStr || '');
  av.textContent = (nickStr && nickStr[0]) ? nickStr[0].toUpperCase() : '?';
  const content = document.createElement('div');
  content.className = 'meta';
  const metaRow = document.createElement('div');
  metaRow.innerHTML = `<span class="nick">${escapeHtml(nickStr||'')}</span>
                       <span class="time">${formatTime(ts)}</span>`;
  const textRow = document.createElement('div');
  textRow.className = 'text';
  textRow.innerHTML = escapeHtml(text||'');
  content.appendChild(metaRow);
  content.appendChild(textRow);
  wrap.appendChild(av);
  wrap.appendChild(content);
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Connect & wire websocket handlers
function connect(){
  statusEl.textContent = 'connecting…';
  try {
    socket = new WebSocket(WS_GATEWAY);
  } catch(e){
    statusEl.textContent = 'connection failed';
    addMessage('system','WebSocket could not be created: '+e.message, Date.now());
    return;
  }

  socket.addEventListener('open', () => {
    statusEl.textContent = 'connected — joining room…';
    // join payload (community clients use this format)
    const joinPayload = { cmd:'join', channel: room, nick: nick };
    socket.send(JSON.stringify(joinPayload));
    // simple keepalive ping so server knows we're alive (optional)
    setInterval(()=>{ if(socket && socket.readyState===1) socket.send(JSON.stringify({cmd:'ping'})); }, 30000);
  });

  socket.addEventListener('message', (ev) => {
    // server sends JSON packets; we handle common cmd types
    let data;
    try { data = JSON.parse(ev.data); } catch(err){ console.warn('non-json',ev.data); return; }

    // Most common fields from community implementations:
    // - cmd: 'chat' / 'message' / 'onlineSet' / 'onlineAdd' / 'onlineRemove' / 'ping' / 'info'
    const cmd = data.cmd || '';
    switch(cmd){
      case 'chat':
      case 'message':
      case 'msg':
        // typical chat message object variants: {cmd:'chat', channel:'room', nick:'Bob', text:'hi', time:ts}
        addMessage(data.nick || data.from || 'unknown', data.text || data.message || data.msg || '', data.time || Date.now());
        break;
      case 'onlineSet':
        // payload.users = [...]
        setUserList(data.users || []);
        break;
      case 'onlineAdd':
        addUser(data.nick || data.user);
        break;
      case 'onlineRemove':
        removeUser(data.nick || data.user);
        break;
      case 'info':
        addMessage('system', data.text || JSON.stringify(data), Date.now());
        break;
      case 'ping':
        // ignore or reply if needed
        break;
      case 'captcha':
        addMessage('system','Captcha required by server — you may be rate limited', Date.now());
        break;
      default:
        // Some servers send messages with other fields (e.g. {nick, text} without cmd) — try to be flexible:
        if (data.nick && (data.text || data.message)) addMessage(data.nick, data.text || data.message, data.time || Date.now());
        // otherwise, ignore or log
        // console.debug('unhandled', data);
    }
  });

  socket.addEventListener('close', (ev) => {
    statusEl.textContent = 'disconnected';
    addMessage('system','Disconnected from server', Date.now());
    // try reconnect after a short delay
    setTimeout(()=>{ connect(); }, 2500);
  });

  socket.addEventListener('error', (err) => {
    statusEl.textContent = 'error';
    console.error('ws err', err);
  });
}

// send text: try common 'say' payload used by community wrappers
function sendText(text){
  if (!socket || socket.readyState !== 1) {
    addMessage('system','Not connected — message not sent', Date.now());
    return;
  }
  const payload = { cmd:'say', channel: room, text: text };
  // also send an alternate form (raw 'msg') for compatibility — some servers accept different fields
  try {
    socket.send(JSON.stringify(payload));
  } catch(e){
    console.error('send failed', e);
  }
  // show local echo immediately
  addMessage(nick, text, Date.now(), {local:true});
  inputEl.value = '';
}

// UI events
sendBtn.addEventListener('click', () => {
  const v = inputEl.value.trim();
  if (v) sendText(v);
});
inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    const v = inputEl.value.trim();
    if (v) sendText(v);
  }
});

// start
connect();

// small accessibility / focus nicety
inputEl.focus();
</script>
</body>
</html>
